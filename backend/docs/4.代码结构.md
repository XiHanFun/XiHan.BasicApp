基于 .NET/ASP.NET Core 的**完整 RBAC 系统 DDD 模块化代码结构**示例。此结构遵循 DDD 五层（API、Application、Domain、Infrastructure、Persistence）+ Shared Kernel 模式，并将核心限界上下文（User、Role、Permission、Session、Constraint）分开组织。

## 概要

该方案将 RBAC 系统拆分为以下项目：

- **Rbac.API**：对外 REST/GraphQL 接口
- **Rbac.Application**：命令/查询处理、DTO、验证器
- **Rbac.Domain**：聚合根、实体、值对象、仓储接口、领域服务、领域事件
- **Rbac.Infrastructure**：外部服务（LDAP、OAuth2）、缓存、消息队列适配器
- **Rbac.Persistence**：EF Core DbContext、实体映射、仓储实现
- **Rbac.SharedKernel**：通用接口、基类、异常、跨上下文的值对象
- **Rbac.Worker**：审计日志、定时清理、异步事件处理
- **Rbac.Tests**：单元测试与集成测试

此结构参考了大型 .NET DDD 工程实践([Medium](https://medium.com/@cizu64/how-to-structure-your-domain-driven-design-project-in-asp-net-core-dbec0cc0ce53?utm_source=chatgpt.com), [Software Engineering Stack Exchange](https://softwareengineering.stackexchange.com/questions/354542/domain-driven-design-in-net-project-structure?utm_source=chatgpt.com))，并结合授权模块的典型划分([GitHub](https://github.com/kgrzybek/modular-monolith-with-ddd?utm_source=chatgpt.com), [Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/ddd-oriented-microservice?utm_source=chatgpt.com))。

------

## 1. 代码总体目录

```
Solution: RbacSolution
├── src/
│   ├── Rbac.API/
│   ├── Rbac.Application/
│   ├── Rbac.Domain/
│   ├── Rbac.Infrastructure/
│   ├── Rbac.Persistence/
│   ├── Rbac.SharedKernel/
│   └── Rbac.Worker/
└── tests/
    └── Rbac.Tests/
```

------

## 2. Domain 层（Rbac.Domain）

```text
Rbac.Domain/
├── UserContext/
│   ├── Aggregates/
│   │   └── User.cs                      # 聚合根：User :contentReference[oaicite:2]{index=2}
│   ├── Entities/
│   │   └── UserProfile.cs               # 实体：UserProfile :contentReference[oaicite:3]{index=3}
│   ├── ValueObjects/
│   │   ├── Credential.cs                # 值对象：密码凭证 :contentReference[oaicite:4]{index=4}
│   │   └── ContactInfo.cs               # 值对象：联系信息 :contentReference[oaicite:5]{index=5}
│   ├── Interfaces/
│   │   └── IUserRepository.cs           # 仓储接口 :contentReference[oaicite:6]{index=6}
│   ├── Events/
│   │   └── UserCreatedEvent.cs          # 领域事件 :contentReference[oaicite:7]{index=7}
│   └── Services/
│       └── UserDomainService.cs         # 领域服务（如密码复杂度校验）:contentReference[oaicite:8]{index=8}
│
├── RoleContext/
│   ├── Aggregates/Role.cs               # 聚合根：Role 
│   ├── Entities/RoleHierarchy.cs        # 实体：层级继承 
│   ├── ValueObjects/RoleAttributes.cs   # 值对象：元数据 :contentReference[oaicite:11]{index=11}
│   ├── Interfaces/IRoleRepository.cs    # 仓储接口 :contentReference[oaicite:12]{index=12}
│   ├── Events/RoleHierarchyChanged.cs   # 领域事件 :contentReference[oaicite:13]{index=13}
│   └── Services/RoleDomainService.cs    # 领域服务（继承逻辑）:contentReference[oaicite:14]{index=14}
│
├── PermissionContext/
│   ├── Aggregates/Permission.cs         # 聚合根：Permission :contentReference[oaicite:15]{index=15}
│   ├── Entities/PermissionAssignment.cs # 实体：权限分配 :contentReference[oaicite:16]{index=16}
│   ├── ValueObjects/Resource.cs         # 值对象：资源 :contentReference[oaicite:17]{index=17}
│   ├── ValueObjects/Action.cs           # 值对象：操作 :contentReference[oaicite:18]{index=18}
│   ├── Interfaces/IPermissionRepository.cs
│   ├── Events/PermissionAssigned.cs
│   └── Services/PermissionDomainService.cs
│
├── SessionContext/
│   ├── Aggregates/Session.cs            # 聚合根：Session :contentReference[oaicite:19]{index=19}
│   ├── Entities/SessionRole.cs          # 实体：激活角色 :contentReference[oaicite:20]{index=20}
│   ├── ValueObjects/SessionContextInfo.cs
│   ├── Interfaces/ISessionRepository.cs
│   ├── Events/SessionStarted.cs
│   └── Services/SessionDomainService.cs  # DSD 约束校验:contentReference[oaicite:21]{index=21}
│
└── ConstraintContext/
    ├── Aggregates/Constraint.cs         # 聚合根：Constraint 
    ├── Entities/ConstraintRule.cs       # 实体：规则项 :contentReference[oaicite:23]{index=23}
    ├── ValueObjects/RuleParameters.cs
    ├── Interfaces/IConstraintRepository.cs
    ├── Events/ConstraintRuleChanged.cs
    └── Services/ConstraintDomainService.cs # SSD/DSD 校验:contentReference[oaicite:24]{index=24}
```

------

## 3. Application 层（Rbac.Application）

```text
Rbac.Application/
├── Common/                           # 公共 DTO 映射、异常
│
├── User/                             # UserContext 用例
│   ├── Commands/
│   │   ├── CreateUserCommand.cs
│   │   └── CreateUserHandler.cs      # 使用 MediatR 处理命令 :contentReference[oaicite:25]{index=25}
│   ├── Queries/
│   │   └── GetUserByIdQuery.cs
│   ├── DTOs/
│   │   └── UserDto.cs
│   └── Validators/
│       └── CreateUserValidator.cs    # FluentValidation :contentReference[oaicite:26]{index=26}
│
├── Role/ …                          # 同上结构：Commands/Queries/DTOs/Validators
├── Permission/ …
├── Session/ …
└── Constraint/ …
```

------

## 4. API 层（Rbac.API）

```text
Rbac.API/
├── Controllers/
│   ├── UsersController.cs            # RESTful 接口 :contentReference[oaicite:27]{index=27}
│   ├── RolesController.cs
│   ├── PermissionsController.cs
│   ├── SessionsController.cs
│   └── ConstraintsController.cs
│
├── Startup.cs / Program.cs           # 配置 MediatR、AutoMapper、Swagger :contentReference[oaicite:28]{index=28}
└── appsettings.json                  # 配置连接串、Jwt、LDAP 等
```

------

## 5. Infrastructure & Persistence

```text
Rbac.Infrastructure/
├── ExternalServices/
│   ├── LdapAuthService.cs            # LDAP/OIDC 授权实现 :contentReference[oaicite:29]{index=29}
│   ├── JwtTokenGenerator.cs
│   └── EmailNotificationService.cs

Rbac.Persistence/
├── DbContexts/
│   └── RbacDbContext.cs              # EF Core DbContext :contentReference[oaicite:30]{index=30}
├── Configurations/
│   └── UserEntityTypeConfiguration.cs
├── Repositories/
│   ├── UserRepository.cs             # 实现 IUserRepository :contentReference[oaicite:31]{index=31}
│   └── RoleRepository.cs
└── Migrations/                       # EF Core 迁移脚本
```

------

## 6. Shared Kernel & Worker

```text
Rbac.SharedKernel/
├── Interfaces/IAggregateRoot.cs
├── BaseEntity.cs
├── DomainException.cs
└── ValueObjects/Pagination.cs

Rbac.Worker/
├── Jobs/
│   └── AuditLogCleanupJob.cs         # 定时清理审计日志
├── EventHandlers/
│   └── UserCreatedEventHandler.cs    # 异步订阅领域事件 :contentReference[oaicite:32]{index=32}
└── WorkerHost.cs                      # 配置 Quartz / Hangfire
```

------

## 7. Tests（Rbac.Tests）

- **单元测试**：Domain 服务、聚合不变量、Application Handler
- **集成测试**：API endpoints、EF Core InMemory、消息队列模拟

------

### 参考与拓展

- 模块化单体 DDD 示例：kgrzybek/modular-monolith-with-ddd ([GitHub](https://github.com/kgrzybek/modular-monolith-with-ddd?utm_source=chatgpt.com))
- 微服务 DDD/CQRS 模式：Microsoft Learn ([Microsoft Learn](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/ddd-oriented-microservice?utm_source=chatgpt.com))
- ASP.NET Core DDD 项目结构指南：Medium ([Medium](https://medium.com/@cizu64/how-to-structure-your-domain-driven-design-project-in-asp-net-core-dbec0cc0ce53?utm_source=chatgpt.com))
- Clean Architecture 与仓储模式：StackOverflow ([Software Engineering Stack Exchange](https://softwareengineering.stackexchange.com/questions/354542/domain-driven-design-in-net-project-structure?utm_source=chatgpt.com))
- RBAC 概念详解：Medium ([Medium](https://medium.com/@eshikashah2001/exploring-role-based-access-control-rbac-32843370e604?utm_source=chatgpt.com))

上述结构可根据团队规模、代码量及微服务拆分需求，进一步拆分或合并限界上下文，以实现高内聚、低耦合的可维护系统。