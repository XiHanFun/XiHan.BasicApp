# XiHan.BasicApp 开发计划

> **建设目标**：权限与系统管理平台（RBAC + 运维审计）  
> **架构模式**：单体应用（支持未来微服务拆分）  
> **部署方式**：私有部署 + SaaS 多租户

---

## 🎯 Sprint 迭代计划

### Sprint 1：系统可运行 + 认证鉴权（2 周）

> **目标**：系统能安全登录、获得 Token，并具备基础权限校验能力

#### 后端核心实现

- [x] **框架层完善**

  - [x] 完善 `XiHan.Framework.Authentication` 模块
  - [x] 完善 `XiHan.Framework.Authorization` 模块
  - [x] 配置依赖注入容器
  - [x] 实现密码哈希（基于 Framework.Security）
  - [x] JWT Token 生成与验证
  - [x] OTP 双因子认证支持

- [ ] **用户体系（核心必做）**

  - [x] 实体：`SysUser`、`SysUserSecurity`、`SysUserSession`
  - [ ] 用户注册、登录、登出
  - [ ] 密码加密与验证（SHA256/SHA512）
  - [ ] 账号状态管理（启用/禁用/锁定）
  - [ ] Session 续期与失效机制
  - [ ] Token 绑定用户会话
  - [ ] 多端登录控制（PC/移动端）

- [ ] **角色权限体系**

  - [x] 实体：`SysRole`、`SysPermission`、`SysRolePermission`、`SysUserRole`、`SysUserPermission`
  - [x] 适配器：`RbacPermissionStore`、`RbacRoleStore`、`RbacPolicyStore`
  - [ ] 角色 CRUD 操作
  - [ ] 权限定义与管理
  - [ ] 角色权限分配
  - [ ] 用户权限直接授予（覆盖机制）
  - [ ] 权限校验中间件
  - [ ] 权限表达式解析（支持 AND/OR/NOT）

- [ ] **菜单/资源管理**

  - [x] 实体：`SysMenu`
  - [ ] 菜单树结构（支持多级）
  - [ ] 菜单类型（目录/菜单/按钮/API）
  - [ ] 菜单权限绑定
  - [ ] 动态路由生成
  - [ ] 前端菜单渲染数据接口

- [ ] **数据库初始化**
  - [ ] SqlSugar 表结构迁移
  - [ ] 种子数据（超管账号、默认角色、基础权限）
  - [ ] 参考：`DATABASE_INITIALIZATION_EXAMPLE.md`

#### 前端基础实现

- [ ] **项目初始化**

  - [ ] Vue 3 + Vite 项目搭建
  - [ ] 集成 XiHan.UI 组件库
  - [ ] 配置 Vue Router
  - [ ] 配置 Pinia 状态管理
  - [ ] Axios 封装（拦截器 + Token 刷新）

- [ ] **登录系统**

  - [ ] 登录页面（账密/验证码）
  - [ ] 记住密码（本地加密存储）
  - [ ] Token 存储与自动续期
  - [ ] 登录过期自动跳转

- [ ] **基础布局**
  - [ ] 顶部导航栏
  - [ ] 侧边菜单栏（树形结构）
  - [ ] 面包屑导航
  - [ ] 用户信息展示与退出

---

### Sprint 2：企业可用 - 组织与租户（2 周）

> **目标**：支持多租户、组织架构、数据权限隔离

#### 后端扩展

- [ ] **多租户支持**

  - [x] 实体：`SysTenant`
  - [ ] 租户 CRUD 操作
  - [ ] 租户数据隔离（SqlSugar 全局过滤器）
  - [ ] 租户资源配额管理
  - [ ] 超管跨租户管理
  - [ ] 租户域名绑定（可选）

- [ ] **组织架构**

  - [x] 实体：`SysDepartment`、`SysUserDepartment`
  - [ ] 部门树形结构（支持多级）
  - [ ] 用户多部门归属
  - [ ] 部门负责人设置
  - [ ] 部门数据授权

- [ ] **数据权限**
  - [x] 实体：`SysRoleDataScope`
  - [ ] 数据范围类型（全部/本部门/本部门及下级/仅本人/自定义部门）
  - [ ] 数据权限过滤器（Repository 级别）
  - [ ] 自定义数据权限规则

#### 前端实现

- [ ] **租户管理**

  - [ ] 租户列表/新增/编辑
  - [ ] 租户状态控制

- [ ] **组织架构**

  - [ ] 部门树组件
  - [ ] 部门 CRUD 操作
  - [ ] 部门人员管理

- [ ] **用户管理**

  - [ ] 用户列表（分页/搜索/筛选）
  - [ ] 用户新增/编辑/禁用
  - [ ] 用户角色分配
  - [ ] 用户部门分配
  - [ ] 用户权限查看

- [ ] **角色管理**
  - [ ] 角色列表
  - [ ] 角色权限分配（树形勾选）
  - [ ] 角色数据权限设置
  - [ ] 角色用户查看

---

### Sprint 3：安全可控 - 审计与日志（2 周）

> **目标**：完整的操作审计、登录监控、安全合规

#### 后端实现

- [ ] **操作日志**

  - [x] 实体：`SysOperationLog`
  - [ ] AOP 拦截器（基于 Attribute）
  - [ ] 记录：操作人、操作时间、操作模块、操作类型、请求参数、响应结果
  - [ ] 敏感信息脱敏
  - [ ] 异步批量写入（防止影响性能）

- [ ] **登录日志**

  - [x] 实体：`SysLoginLog`
  - [ ] 记录：登录账号、登录时间、IP 地址、设备信息、登录结果
  - [ ] 异常登录检测（多地登录、频繁失败）
  - [ ] 登录地理位置解析（IP 库）

- [ ] **API 请求日志**

  - [x] 实体：`SysApiLog`
  - [ ] 关键 API 请求记录
  - [ ] 慢查询监控（响应时间超过阈值）
  - [ ] API 调用统计

- [ ] **系统审计**
  - [x] 实体：`SysAudit`、`SysAuditLog`
  - [ ] 关键配置变更审计
  - [ ] 权限变更审计
  - [ ] 审计日志不可篡改（签名机制）

#### 前端实现

- [ ] **日志查询**

  - [ ] 操作日志查询（多条件筛选）
  - [ ] 登录日志查询
  - [ ] API 日志查询
  - [ ] 日志详情展示
  - [ ] 日志导出（Excel/CSV）

- [ ] **安全监控**
  - [ ] 登录趋势图表
  - [ ] 异常登录告警
  - [ ] 操作热力图

---

### Sprint 4：业务增强能力（3 周）

> **目标**：通用业务能力、系统配置、通知中心

#### 后端实现

- [ ] **文件管理**

  - [x] 实体：`SysFile`
  - [ ] 文件上传（本地/OSS/MinIO）
  - [ ] 文件下载/预览
  - [ ] 文件大小/类型限制
  - [ ] 文件清理策略

- [ ] **通知中心**

  - [x] 实体：`SysNotification`
  - [ ] 站内消息推送
  - [ ] 消息模板管理
  - [ ] 未读消息统计
  - [ ] WebSocket 实时推送

- [ ] **邮件/短信**

  - [x] 实体：`SysEmail`、`SysSms`
  - [ ] 邮件发送（SMTP）
  - [ ] 短信发送（阿里云/腾讯云）
  - [ ] 发送记录与状态跟踪

- [ ] **系统配置**

  - [x] 实体：`SysConfig`
  - [ ] 配置项分组管理
  - [ ] 配置热更新
  - [ ] 敏感配置加密存储

- [ ] **数据字典**
  - [x] 实体：`SysDict`、`SysDictItem`
  - [ ] 字典分类管理
  - [ ] 字典项 CRUD
  - [ ] 前端字典缓存

#### 前端实现

- [ ] **文件管理**

  - [ ] 文件上传组件（拖拽/粘贴）
  - [ ] 图片预览/裁剪
  - [ ] 文件列表管理

- [ ] **通知中心**

  - [ ] 消息铃铛组件
  - [ ] 消息列表/已读/删除
  - [ ] 消息详情弹窗

- [ ] **系统设置**
  - [ ] 配置项管理界面
  - [ ] 字典管理界面
  - [ ] 系统参数配置

---

### Sprint 5+：扩展能力（按需实施）

#### OAuth / 第三方集成

- [x] 实体：`SysOAuthApp`、`SysOAuthCode`、`SysOAuthToken`
- [ ] OAuth2 授权码模式
- [ ] 第三方应用管理
- [ ] SSO 单点登录
- [ ] 第三方登录（微信/GitHub）

#### 任务调度

- [x] 实体：`SysTask`、`SysTaskLog`
- [ ] 定时任务配置（Cron 表达式）
- [ ] 任务执行日志
- [ ] 任务失败重试
- [ ] 任务监控面板

#### 访问统计

- [x] 实体：`SysAccessLog`、`SysUserStatistics`
- [ ] 用户行为分析
- [ ] 访问热力图
- [ ] 数据报表生成

#### 代码生成器

- [ ] 代码模板管理
- [ ] 基于数据库表生成 CRUD
- [ ] 生成前后端代码
- [ ] 支持自定义模板

---

## 📊 模块优先级矩阵

| 优先级 | 模块分类 | 具体模块                | 是否核心         | 完成状态      |
| ------ | -------- | ----------------------- | ---------------- | ------------- |
| **P0** | 认证鉴权 | 用户、会话、密码、Token | ✅ 核心必做      | 🟢 框架已完成 |
| **P0** | 权限体系 | 角色、权限、菜单、策略  | ✅ 核心必做      | 🟡 适配进行中 |
| **P1** | 多租户   | 租户管理、数据隔离      | ⚠️ SaaS 必做     | ⚪ 待开发     |
| **P1** | 组织架构 | 部门、用户部门关系      | ⚠️ 企业必做      | ⚪ 待开发     |
| **P1** | 数据权限 | 数据范围、自定义规则    | ⚠️ 企业必做      | ⚪ 待开发     |
| **P2** | 审计日志 | 操作日志、登录日志      | ✅ 安全必做      | ⚪ 待开发     |
| **P2** | API 日志 | 请求日志、慢查询监控    | ✅ 稳定必做      | ⚪ 待开发     |
| **P2** | 系统审计 | 审计记录、不可篡改      | ⚠️ 金融/政府必做 | ⚪ 待开发     |
| **P3** | 文件管理 | 上传、下载、预览        | 🔵 辅助能力      | ⚪ 待开发     |
| **P3** | 通知中心 | 站内消息、推送          | 🔵 辅助能力      | ⚪ 待开发     |
| **P3** | 短信邮件 | 发送、模板、记录        | 🔵 辅助能力      | ⚪ 待开发     |
| **P3** | 配置中心 | 配置管理、热更新        | 🔵 辅助能力      | ⚪ 待开发     |
| **P3** | 数据字典 | 字典管理、缓存          | 🔵 辅助能力      | ⚪ 待开发     |
| **P4** | OAuth    | OAuth2、第三方登录      | 🟣 可选          | ⚪ 待开发     |
| **P4** | SSO      | 单点登录、统一认证      | 🟣 可选          | ⚪ 待开发     |
| **P5** | 任务调度 | 定时任务、任务监控      | 🟣 可选          | ⚪ 待开发     |
| **P6** | 访问统计 | 行为分析、数据报表      | 🟣 可选          | ⚪ 待开发     |
| **P6** | 用户画像 | 统计分析、BI            | 🟣 可选          | ⚪ 待开发     |

**图例说明**：

- 🟢 已完成 🟡 进行中 ⚪ 待开发 🔴 已废弃
- ✅ 核心必做 ⚠️ 场景必做 🔵 辅助能力 🟣 可选扩展

---

## 🏗️ 架构决策与技术选型

### 系统定位

- **部署模式**：私有部署 + SaaS 多租户
- **架构风格**：单体应用（预留微服务拆分能力）
- **数据隔离**：基于 TenantId 的逻辑隔离

### 技术栈

#### 后端

- **框架**：.NET 8.0 / ASP.NET Core
- **ORM**：SqlSugar（代码优先）
- **数据库**：SQL Server / MySQL / PostgreSQL（多数据库支持）
- **认证**：JWT + Cookie（双模式）
- **密码**：SHA256/SHA512 + Salt
- **缓存**：Memory Cache / Redis
- **日志**：Serilog + Seq
- **文档**：Swagger / Scalar

#### 前端

- **框架**：Vue 3 + TypeScript
- **构建**：Vite
- **UI**：XiHan.UI（基于 Element Plus）
- **状态**：Pinia
- **路由**：Vue Router
- **请求**：Axios
- **图表**：ECharts

### 分层架构

```
XiHan.BasicApp
├── XiHan.Framework                 # 框架层
│   ├── Core                        # 核心抽象
│   ├── AspNetCore                  # Web 扩展
│   ├── Authentication              # 认证框架 ✅
│   ├── Authorization               # 授权框架 ✅
│   ├── Security                    # 安全工具 ✅
│   └── SqlSugar                    # ORM 扩展
├── XiHan.BasicApp.Rbac             # RBAC 业务模块 🟡
│   ├── Entities                    # 实体定义 ✅
│   ├── Repositories                # 数据访问 🟡
│   ├── Managers                    # 领域逻辑 🟡
│   ├── Adapters                    # 框架适配 🟡
│   ├── Services                    # 应用服务 ⚪
│   └── Seeders                     # 种子数据 ⚪
└── XiHan.BasicApp.Host             # 宿主程序 ⚪
```

### 开发原则

1. **领域驱动设计（DDD）**

   - Managers：领域业务逻辑（唯一性校验、业务规则）
   - Adapters：框架集成适配（连接领域层与框架层）
   - Services：应用服务（协调多个领域对象）

2. **依赖注入**

   - 使用 `Microsoft.Extensions.DependencyInjection`
   - 单例服务：无状态、线程安全
   - 作用域服务：数据库上下文、Repository

3. **异步优先**

   - 所有 I/O 操作使用 `async/await`
   - 支持 `CancellationToken`

4. **安全第一**
   - 所有密码必须加密存储
   - 敏感配置加密
   - SQL 注入防护（ORM 参数化）
   - XSS 防护（前端转义）

---

## 🎯 当前阶段工作重点（Sprint 1）

### ✅ 已完成

1. ✅ `XiHan.Framework.Authentication` 模块开发

   - ✅ 密码哈希器（基于 Security 模块）
   - ✅ JWT Token 服务
   - ✅ OTP 服务（TOTP/HOTP）
   - ✅ 认证服务接口

2. ✅ `XiHan.Framework.Authorization` 模块开发

   - ✅ 权限存储接口
   - ✅ 角色存储接口
   - ✅ 策略存储接口
   - ✅ 授权服务接口

3. ✅ `XiHan.BasicApp.Rbac` 实体设计

   - ✅ 30+ 实体类定义
   - ✅ 继承 `RbacFullAuditedEntity<long>`
   - ✅ 部分实体 Partial 扩展

4. 🟡 `XiHan.BasicApp.Rbac` 适配器开发

   - ✅ `RbacAuthenticationService`（认证适配）
   - ✅ `RbacPermissionStore`（权限存储适配）
   - ✅ `RbacRoleStore`（角色存储适配）
   - ✅ `RbacRoleManager`（角色管理适配）
   - ✅ `RbacPolicyStore`（策略存储适配）

5. 🟡 `XiHan.BasicApp.Rbac` 领域管理器

   - ✅ `UserManager`（用户业务规则）
   - ✅ `RoleManager`（角色业务规则）
   - ✅ `PermissionManager`（权限业务规则）
   - ✅ `DepartmentManager`（部门业务规则）

6. 🟡 `XiHan.BasicApp.Rbac` 仓储层
   - ✅ 部分 Repository 接口与实现
   - 🟡 需补充方法实现

### 🎯 下一步工作（按优先级）

#### 1. 完善 Repository 层（2 天）

- [ ] 完成所有 Repository 接口定义
- [ ] 实现核心 Repository 方法
  - [ ] `ISysUserRepository`
  - [ ] `ISysRoleRepository` ✅
  - [ ] `ISysPermissionRepository`
  - [ ] `ISysMenuRepository`
  - [ ] `ISysUserPermissionRepository` ✅
  - [ ] `ISysTenantRepository`
  - [ ] `ISysDepartmentRepository`

#### 2. 实现应用服务层（3 天）

- [ ] 用户服务（`SysUserService`）

  - [ ] 用户注册/登录/登出
  - [ ] 用户信息管理
  - [ ] 密码修改/重置
  - [ ] 账号状态控制

- [ ] 角色服务（`SysRoleService`）

  - [ ] 角色 CRUD
  - [ ] 角色权限分配
  - [ ] 角色数据权限设置

- [ ] 权限服务（`SysPermissionService`）

  - [ ] 权限 CRUD
  - [ ] 权限树查询

- [ ] 菜单服务（`SysMenuService`）
  - [ ] 菜单 CRUD
  - [ ] 用户菜单查询
  - [ ] 动态路由生成

#### 3. 数据库初始化（1 天）

- [ ] SqlSugar 配置
- [ ] 表结构迁移
- [ ] 种子数据（参考 `DATABASE_INITIALIZATION_EXAMPLE.md`）
  - [ ] 超级管理员
  - [ ] 默认角色
  - [ ] 基础权限
  - [ ] 系统菜单

#### 4. API 控制器层（2 天）

- [ ] 认证控制器（登录/登出/刷新 Token）
- [ ] 用户控制器
- [ ] 角色控制器
- [ ] 权限控制器
- [ ] 菜单控制器

#### 5. 中间件与过滤器（1 天）

- [ ] JWT 认证中间件
- [ ] 权限校验过滤器
- [ ] 全局异常处理
- [ ] 操作日志记录（AOP）

#### 6. 前端登录系统（2 天）

- [ ] 登录页面
- [ ] Token 管理
- [ ] 路由守卫
- [ ] 基础布局

---

## 📝 开发规范与约定

### 命名规范

- **实体**：`Sys` + 业务名（如 `SysUser`）
- **接口**：`I` + 实体名 + `Repository/Service/Manager`
- **DTO**：实体名 + `Dto/Input/Output`
- **常量**：全大写下划线分隔（`MAX_LOGIN_ATTEMPTS`）

### 代码规范

- **后端**：遵循 C# .NET 编码规范
- **前端**：遵循 Vue.js 最佳实践 + ESLint
- **数据库**：表名 `sys_user`，字段名 `user_name`（下划线命名）

### 注释规范

- **XML 文档注释**：所有 public 成员必须有 `<summary>`
- **版权注释**：所有文件头部包含版权信息
- **TODO 注释**：待完成功能标记 `// TODO: 功能描述`

### Git 提交规范

```
feat: 新功能
fix: 修复 Bug
docs: 文档更新
style: 代码格式（不影响功能）
refactor: 重构
perf: 性能优化
test: 测试相关
chore: 构建/工具链
```
